# Исчисление конструкций

Хотя используя лямбда-исчисление можно вычислить всё, что может быть вычисленно посредством переписывания символов на бумаге, в качестве основания математики оно непригодно.

Проблема заключается в том, что ничем не ограниченные ссылки на себя ведут к парадоксам. Например, рассмотрим утверждение:

$$L := \text{утверждение } L\ \text{ложно}$$

Если $L$ истино, то оно должно быть ложно, однако если $L$ ложно, то оно должно быть истино. Противоречие.

Кроме того, существут синтаксически корректные, но заведомо бессмысленные выражения. Например:

$$1\ (4 + λx.\;x)$$

Хотелось бы избежать необходимости рассуждать про бессмысленные выражения.

Обе проблемы решаются введением *типов*. Тип это класс значений по происхождению. У каждого корректного выражения есть тип, и мы рассматриваем только те выражения, которые могут быть типизированы.

При этом, типы также являются выражениями, которые могут быть вычисленны.

Вместо бестипового лямбда-исчисления мы будем использовать формальную систему, называющуюся исчислением конструкций.

Синтаксис:

$$\begin{aligned}
{\color{red}expr} ::=\ &{\color{red}var} & &\text{(имя переменной)} \\
\mid\quad &λ\, {\color{red}var}\ {:}\ {\color{red}expr}\, .\ {\color{red}expr} & &\text{(абстракция)} \\
\mid\quad &{\color{red}expr}\ {\color{red}expr} & &\text{(применение)} \\
\mid\quad &\mathcal{U}\ {\color{red}nat} & &\text{(вселенная типов)} \\
\mid\quad &∀ \, {\color{red}var}\ {:}\ {\color{red}expr}\, .\ {\color{red}expr} & &\text{(тип функций)} \\
\end{aligned}$$

В абстракции появилось выражение после двоеточия. Это и есть тип переменной.

Кроме того:

- Вселенные типов пронумерованы натуральными числами: $\mathcal U\ 0$, $\mathcal U\ 1$, ...
- Как и $λ$, $∀$ также связывает переменные
  - И захватывает всё, что справа
- Тип $∀{\color{red}x}: {\color{red}α}.\; {\color{red}β}$ также записывается как $(\textcolor{red}x: {\color{red}α}) → {\color{red}β}$
  - Или даже как ${\color{red}α} → {\color{red}β}$, если в $\color{red}β$ нет свободных вхождений переменной $\color{red}x$
  - Стрелка правоассоциативна: ${\color{red}α} → {\color{red}β} → {\color{red}γ}$ означает ${\color{red}α} → ({\color{red}β} → {\color{red}γ})$
- $λ({\color{red}x}:{\color{red}α})({\color{red}y}:{\color{red}β}).\; {\color{red}e}$ означает $λ{\color{red}x}:{\color{red}α}.\;λ{\color{red}y}:{\color{red}β}.\; {\color{red}e}$
  - Аналогично для $∀({\color{red}x}:{\color{red}α})({\color{red}y}:{\color{red}β}).\; {\color{red}τ}$

Как и в лямбда-исчислении, правилом вычисления в исчислении конструкций является бета-редукция:

$$(λ{\color{red}x}:{\color{red}α}.\; {\color{red}e})\ {\color{red}v} ⟶ \; {\color{red}e}[{\color{red}x} := {\color{red}v}]$$

Мы рассматриваем только корректно типизированные выражения. Выражение называется корректно типизированным, если у него есть тип. Факт того, что выражение ${\color{red}e}$ имеет тип ${\color{red}τ}$ записывается как ${\color{red}e}:{\color{red}τ}$.

Опишем неформально принципы, по которым выражение может иметь какой-либо тип.

${\color{red}f} : ∀{\color{red}x}:{\color{red}α}.\; {\color{red}β}$ означает, что выражение ${\color{red}f}$ может быть применено только к значениям типа ${\color{red}α}$, а результатом является значение типа ${\color{red}β}$. При этом, тип результата может зависеть от аргумента функции: выражение ${\color{red}f}\ {\color{red}v}$ имеет тип ${\color{red}β}[{\color{red}x} := {\color{red}v}]$.

Единственное предназначение вселенных типов это быть типом для других типов. Поскольку $\mathcal U : \mathcal U$ приводит к парадоксу Жирара, вместо одной вселенной у нас есть целая иерархия:

$$\mathcal U\ 0 : \mathcal U\ 1 \qquad \mathcal U\ 1: \mathcal U\ 2 \qquad \dots$$

Если ${\color{red}α}: \mathcal U\ i$ и ${\color{red}β}: \mathcal U\ j$, то тогда $(∀{\color{red}x}:{\color{red}α}.\; {\color{red}β}) : \mathcal U\ max(i,j)$, где $max(i,j)$ это наибольшее из двух чисел. Причины, почему $∀{\color{red}x}:{\color{red}α}.\; {\color{red}β}$ живёт в наибольшей из двух вселенных довольно тонкие, но тоже связаны с противоречивостью при некоторых дополнительных предположениях.

Если ${\color{red}e}:{\color{red}α}$, и ${\color{red}β}$ это корректно типизированных тип, такой, что ${\color{red}α} \equiv {\color{red}β}$, то тогда ${\color{red}e}:{\color{red}β}$. Иначе говоря, мы считаем вычислительно равные типы равными.

Правила типизации критически важны для понимания этой книги, так что опишем их также и механически.

Суждение о том, что выражение имеет определённый тип выводится с помощью правил вывода. Правило, по которому из суждений $j_1$, …, $j_n$ можно вывести суждение $c$ записывается как

$$\frac{j_1\qquad \dots\qquad j_n}{c}$$

Если часть над чертоё пуста, то вывод заключения не требует предпосылок.

Правила вывода можно читать не только сверху вних, но и снизу вверх: чтобы вывести $c$, нужно сначала вывести $j_1$, …, $j_n$.

Пример: пусть есть суждения вида ${\color{red}x} \sim {\color{red}y}$. И есть следующие правила вывода:

$$\frac{{\color{red}x} \sim {\color{red}y}}{{\color{red}y} \sim {\color{red}x}} \qquad
\frac{{\color{red}x} \sim {\color{red}y}\qquad {\color{red}y}\sim{\color{red}z}}{{\color{red}x} \sim {\color{red}z}}$$

Покажем, как из суждений $a \sim b$ и $a \sim c$ можно вывести $b \sim c$:

1. Предпосылки: $a \sim b$ и $a \sim c$
2. Применив второе правило к $a \sim b$, выводим $b \sim a$
3. Применив третье правило к $b \sim a$ и $a \sim c$, выводим $b \sim c$

Суждение, что в контексте $Γ$, выражение $\textcolor{red}x$ имеет тип $\textcolor{red}α$, записывается как

$$Γ ⊢ \textcolor{red}x:\textcolor{red}α$$

Контекст типизации это список пар вида ${\color{red}v}:{\color{red}τ}$, где $\color{red}v$ это переменная, а $\color{red}τ$ — её тип. Контекст хранит информацию о типах свободных переменных.

Пример контекста:

$$(α\,β\,Nat: \mathcal U\ 1),(Fin: Nat → \mathcal U\ 1),(n:Nat), (x: Fin\ n)$$

Мы пишем $Γ,({\color{red}v}:{\color{red}τ})$ чтобы присоединить пару ${\color{red}v}:{\color{red}τ}$ к контексту $Γ$.

Наконец, мы можем описать правила типизации.

Начальное правило проще описать словами: для каждой переменной ${\color{red}v}$, если из всех пар вида ${\color{red}v}:{\color{red}τ}$ пара ${\color{red}v}:{\color{red}α}$ является последней в $Γ$, то тогда $Γ ⊢ {\color{red}v}:{\color{red}α}$.

Например:

$$\begin{aligned}
(Nat: \mathcal U\ 1),(x:Nat), (α: \mathcal U\ 1), (x:α) &⊢ x:α \\
(Nat: \mathcal U\ 1),(x:Nat), (α: \mathcal U\ 1), (x:α) &⊢ α:\mathcal U\ 1
\end{aligned}$$

Остальные правила опишем символьно.

- Вселенные:

$$\frac{}{Γ ⊢ \mathcal U\ i : \mathcal U\ (i + 1)}$$

- Тип зависимых функций:

$$\frac{
  Γ ⊢ {\color{red}α}: \mathcal U\ i \qquad
  Γ,({\color{red}x}: {\color{red}α}) ⊢ {\color{red}β}: \mathcal U\ j
}{Γ ⊢ (∀{\color{red}x}:{\color{red}α}.\; {\color{red}β}): \mathcal U\ max(i,j)}$$

- Абстракция:

$$\frac
{ Γ,({\color{red}x}:{\color{red}α}) ⊢ {\color{red}e}:{\color{red}β} \qquad
  Γ ⊢ (∀{\color{red}x}:{\color{red}α}.\;{\color{red}β}):\mathcal U\ i      }
{Γ ⊢ (λ{\color{red}x}:{\color{red}α}.\;{\color{red}e}):
  (∀{\color{red}x}:{\color{red}α}.\;{\color{red}β})                        }$$

- Применение:

$$\frac
{ Γ ⊢ {\color{red}f}:(∀{\color{red}x}:{\color{red}α}.\;{\color{red}β})\qquad
  Γ⊢ {\color{red}v}:{\color{red}α}                                           }
{Γ ⊢ ({\color{red} f\ v}): {\color{red}β}[{\color{red}x} := {\color{red}v}]}$$

- Вычислительное равенство:

$$\frac
{ Γ ⊢ \textcolor{red}e: \textcolor{red}α\qquad
  \textcolor{red}α \equiv \textcolor{red}β\qquad
  Γ ⊢ \textcolor{red}β: \mathcal U\ i}
{Γ ⊢ \textcolor{red}e:\textcolor{red}β}$$


Рассмотрим пример. Типизировнная версия выражения $λx\,y.\;x$ выглядит так:

$$\big(λ(α\, β:\mathcal U\ 1)(x:α)(y:β).\;x\big) : ∀α\,β:\mathcal U\ 1.\; α → β → α$$

Покажем, что выражение действительно имеет этот тип.

Сначала, применяя правила в обратном порядке, покажем, что тип корректно типизирован:

$$\begin{aligned}
&⊢ (∀α\,β:\mathcal U\ 1.\; α → β → α): \mathcal U\ 2 \\
&⊢ \mathcal U\ 1 : \mathcal U\ 2 \\
(α:\mathcal U\ 1) &⊢ (∀β:\mathcal U\ 1.\; α → β → α): \mathcal U\ 2 \\
(α:\mathcal U\ 1) &⊢ \mathcal U\ 1 : \mathcal U\ 2 \\
(α:\mathcal U\ 1), (β:\mathcal U\ 1) &⊢ (α → β → α): \mathcal U\ 1 \\
(α:\mathcal U\ 1), (β:\mathcal U\ 1) &⊢ α: \mathcal U\ 1 \\
(α:\mathcal U\ 1), (β:\mathcal U\ 1),({\color{red}u}:α) &⊢ (β → α): \mathcal U\ 1 \\
(α:\mathcal U\ 1), (β:\mathcal U\ 1),({\color{red}u}:α) &⊢ β: \mathcal U\ 1 \\
(α:\mathcal U\ 1), (β:\mathcal U\ 1),({\color{red}u}:α),({\color{red}v}:β) &⊢ α: \mathcal U\ 1 \\
\end{aligned}$$

Здесь $\color{red}u$ и $\color{red}v$ это неиспользованные переменные в типе функций.

Теперь покажем, что выражение действительно имеет требуемый тип:

$$\begin{aligned}
&⊢ \big(λ(α\, β:\mathcal U\ 1)(x:α)(y:β).\;x\big) : ∀α\,β:\mathcal U\ 1.\; α → β → α \\
(α:\mathcal U\ 1) &⊢ \big(λ(β:\mathcal U\ 1)(x:α)(y:β).\;x\big) : ∀β:\mathcal U\ 1.\; α → β → α \\
(α:\mathcal U\ 1),(β:\mathcal U\ 1) &⊢ \big(λ(x:α)(y:β).\;x\big) :  α → β → α \\
(α:\mathcal U\ 1),(β:\mathcal U\ 1),(x:α) &⊢ \big(λ(y:β).\;x\big) :  β → α \\
(α:\mathcal U\ 1),(β:\mathcal U\ 1),(x:α),(y:β) &⊢ x : α \\
\end{aligned}$$

Суждения о типах опущены, так как мы уже выводили их раньше.

Подобная проверка типов — полностью механический процесс, что позволяет поручить её компьютеру.
